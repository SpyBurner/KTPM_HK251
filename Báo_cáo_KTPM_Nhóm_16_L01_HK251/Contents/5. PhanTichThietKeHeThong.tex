\section{Phân tích \& Thiết kế hệ thống}
\subsection{Entity Relationship Diagram (ERD)}
\subsubsection{Tổng quan}

\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\linewidth]{"Images/5. PhanTichThietKeHeThong/ERD.png"}
	\caption{Entity Relationship Diagram}
	\label{fig:erd}
\end{figure}

\textbf{Tổng quan các Thực thể}\\
\indent Sơ đồ có tổng cộng 16 thực thể được chia thành 4 lĩnh vực (Domain): Quiz (Bài kiểm tra), Course Modification (Điều chỉnh Khóa học), Course Learning (Học tập Khóa học), và System (Hệ thống).

Course Modification, Quiz và Course Learning chia hệ thống thành 2 mảng tách rời nhưng tương trợ lẫn nhau: chỉnh sửa nội dung khóa học và sử dụng khóa học.

\begin{itemize}

	\item \textbf{Domain: Quiz (Bài kiểm tra)}\\
	Bao gồm các thực thể phục vụ định nghĩa các bài quiz, và ghi lại tương tác của Student trên các bài quiz này.
	\begin{itemize}
		\item \textbf{Quiz}: Đại diện cho một bài kiểm tra hoặc bài tập tổng thể.
		\item \textbf{Question}: Đại diện cho một câu hỏi cụ thể trong Quiz.
		\item \textbf{Answer}: Đại diện cho một lựa chọn trả lời khả dụng cho một Question.
		\item \textbf{Quiz Attempt}: Đại diện cho một lần làm Quiz cụ thể của một Student.
	\end{itemize}
	
	\item \textbf{Domain: Course Modification (Chỉnh sửa Khóa học)}\\
	Bao gồm các thực thể phục vụ định nghĩa các khóa học, phân chia một khóa học thành các đơn vị nhỏ, dễ truy xuất, tham chiếu.
	\begin{itemize}
		\item \textbf{Course}: Đại diện cho một khóa học hoàn chỉnh.
		\item \textbf{Chapter}: Đại diện cho một chương (bài học lớn) trong Course.
		\item \textbf{Topic}: Đại diện cho một chủ đề nhỏ hơn nằm trong Chapter.
		\item \textbf{Section}: Đại diện cho một phần nội dung, chứa các Quiz hoặc Topic.
	\end{itemize}
	
	\item \textbf{Domain: Course Learning (Học Khóa học)}\\
	Bao gồm các thực thể phục vụ các tương tác lên khóa học và quiz.
	\begin{itemize}
		\item \textbf{Forum message}: Đại diện cho một bài viết/bình luận trong diễn đàn.
	\end{itemize}
	
	\item \textbf{Domain: System (Hệ thống)}\\
	Bao gồm các thực thể phục vụ việc định danh người dùng, phân quyền, điều khiển và vận hành cho Admin.
	\begin{itemize}
		\item \textbf{User}: Đại diện cho người dùng chung của hệ thống (thực thể cha).
		\item \textbf{Admin / Dean / Lecturer / TA}: Đại diện cho người dùng có vai trò quản trị/giảng dạy, là thực thể con của User.
		\item \textbf{Student}: Đại diện cho người dùng có vai trò là học viên, là thực thể con của User.
		\item \textbf{File}: Đại diện cho các tài liệu được Upload lên hệ thống.
		\item \textbf{System config}: Đại diện cho các cài đặt cấu hình của toàn bộ hệ thống.
		\item \textbf{Privilege}: Đại diện cho các quyền hạn cụ thể của User.
		\item \textbf{Log}: Đại diện cho các bản ghi nhật ký hoạt động của User.
	\end{itemize}
\end{itemize}

\textbf{Các mối quan hệ giữa các thực thể}\\
\begin{longtable}{|p{1cm} |p{2cm} | p{1.5cm} | p{2cm} | p{4cm} | p{2cm} |}
	\hline
	\textbf{Domain} & \textbf{Thực thể 1} & \textbf{Tên Mối Quan hệ} & \textbf{Thực thể 2} & \textbf{Kiểu Mối Quan hệ (Cardinality)} & Yêu cầu liên quan \\
	\hline
	
	Quiz & Quiz & Contain & Question & 1:N - Một Quiz có nhiều Question & \ref{us:L-US02}, \ref{us:T-US02}, \ref{nfr:07}, \ref{nfr:15}\\
	\hline
	Quiz & Question & Contain & Answer & 1:N - Một Question có nhiều Answer & \\
	\hline
	Quiz & Quiz Attempt & Of & Quiz  & N:1 - Nhiều QuizAttempt thuộc về một Quiz & \\
	\hline
	Quiz & Student & Take & Quiz Attempt & 1:N - Một Student thực hiện nhiều bài Quiz & \\
	\hline
	Quiz & Admin / Dean / Lecturer / TA & Change & Quiz & 1:N - Một người dùng có quyền hạn có thể chỉnh sửa nhiều bài quiz & \\
	\hline
	
	Course Mod. & Course & Contain & Chapter & 1:N - Một Course có nhiều Chapter & \\
	\hline
	Course Mod. & Chapter & Contain & Section & 1:N - Một Chapter có nhiều Section & \\
	\hline
	Course Mod. & Chapter & Contain & Topic & 1:N - Một Chapter có nhiều Topic & \\
	\hline
	Course Mod. & Section & Contain & File  & 1:N - Một Section có nhiều file (tài liệu, video,...) & \\
	\hline
	Course Mod. & Section & Contain & Quiz  & 1:N - Một Section có nhiều Quiz & \\
	\hline
	Course Mod. & Admin / Dean / Lecturer / TA & Change & Course  & 1:N - Một người dùng có quyền hạn chỉnh sửa nhiều Course& \\
	\hline
	Course Mod. & Admin / Dean / Lecturer / TA & Change & Chapter  & 1:N - Một người dùng có quyền hạn chỉnh sửa nhiều Chapter& \\
	\hline
	Course Mod. & Admin / Dean / Lecturer / TA & Change & Section & 1:N - Một người dùng có quyền hạn chỉnh sửa nhiều Section& \\
	\hline
	
	Course Learn. & Student & Finish & Chapter & N:N - Nhiều Student hoàn thành nhiều Chapter & \\
	\hline
	Course Learn. & Student & Enroll & Course & N:N - Nhiều Student đăng ký nhiều Course & \\
	\hline
	Course Learn. & User & Post & Forum message & 1:N - Một User đăng tải nhiều Forum message & \\
	\hline
	Course Learn. & User & Post & Forum message & 1:N - Một User đăng tải nhiều Forum message & \\
	\hline
	Course Learn. & Course & Contain & Forum message & 1:N - Một Course có nhiều Forum message & \\
	\hline
	
	System & User & Upload & File & 1:1 - Một User đăng tải một File (ảnh đại diện) & \\
	\hline
	System & User & Has & Privilege & N:N - Nhiều User có nhiều Privilege & \\
	\hline
	System & Privilege & Grant access to & Course & N:1 - Nhiều Privilege cho phép truy cập một Course (2 dạng chỉ xem hoặc chỉnh sửa)& \\
	\hline
	System & Log & Track & User & N:1 - Nhiều Log theo dõi một User - để truy vấn trách nhiệm khi có sửa đổi & \\
	\hline
	System & Admin / Dean / Lecturer / TA & Change & System config & N:N - Nhiều người dùng có quyền hạn thay đổi nhiều System config & \\
	\hline
	System & System config & Exclude & Course & 1:N - Một System config chứa thông tin về bỏ qua nhiều Course (hỗ trợ AI Service - use-case UC-SM-01)& \\
	\hline
\end{longtable}

\textit{Mối Quan hệ Kế thừa (Inheritance/Specialization)}: Mối quan hệ này được biểu thị bằng ký hiệu vòng tròn \textbf{D} (Disjoint), nghĩa là người dùng Student sẽ không thể có được các quyền hạn ngang hàng với Admin, Lecturer, TA:

\textit{Mối Quan hệ bậc 3}: Mối quan hệ Contain N-N-N giữa Quiz Attempt, Question và Answer có vai trò lưu giữ câu trả lời của Student cho mỗi câu hỏi tương ứng trong một lần làm quiz.

\subsubsection{Mapping}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\linewidth]{"Images/5. PhanTichThietKeHeThong/ERD(1).png"}
	\caption{Relational Mapping Diagram}
	\label{fig:mapping}
\end{figure}
Triển khai từ ERD ở phần trước, sơ đồ mapping bổ sung thêm các trường dữ liệu cho các bảng để hoàn thiện thiết kế cấu trúc dữ liệu.

\textbf{Một số chi tiết đáng lưu ý}:
\begin{itemize}
	\item Bảng AI Log chỉ dùng để lưu trữ các thông tin hoạt động của AI service, không có quan hệ với bảng nào khác.
	\item Tất cả các bảng đều có các trường createDateTime - thời điểm record đó được tạo ra, và isDeleted - hỗ trợ tính năng soft-delete
	\item Privilege được chia làm 2 loại (type): ACCESS - chỉ truy cập và đọc nội dung, dành cho Student, EDIT - truy cập và chỉnh sửa nội dung, dành cho Lecturer, TA.
\end{itemize}

\subsection{Lựa chọn kiến trúc hệ thống}
\subsubsection{Đặc tính kiến trúc (Architecture characteristics)}
Ứng dụng phương pháp \textbf{Architecture Katas} lên các yêu cầu hệ thống ở bảng \ref{tab:user_stories} và \ref{tab:nfr_list_ref}, nhóm đề xuất ra 3 đặc tính chính của hệ thống:

\begin{enumerate}
	\item \textbf{Configurability} \label{ac:01}, vì:
	
	\begin{itemize}
		\item \textbf{Quản lý hệ thống:} Cho phép thay đổi cách thức vận hành của hệ thống mà không cần can thiệp hoặc chỉnh sửa trực tiếp vào mã nguồn. Đặc tính này bao gồm việc \textit{Đối với mô hình Trí tuệ nhân tạo (AI)} thì có khả năng thiết lập \textit{chu kỳ tự động bảo trì}. Tương ứng với: \ref{nfr:01}, \ref{nfr:02}.
		
		\item \textbf{Chỉnh sửa khóa học:} Cho phép cấu hình \textit{kiểu tài liệu} người dùng được phép đăng tải, cũng như chỉnh sửa \textit{layout (bố cục) giao diện khóa học} hiển thị cho người dùng. Tương ứng với: \ref{nfr:03}, \ref{nfr:04}.
		
		\item \textbf{Tạo báo cáo:} Người dùng có thể \textit{thay đổi layout} của báo cáo được tạo ra và \textit{thay đổi phạm vi dữ liệu} được sử dụng để lập báo cáo. Tương ứng với: \ref{nfr:05}, \ref{nfr:06}.
		
		\item \textbf{Tạo câu đố bằng AI:} Cho phép cấu hình các tham số tạo câu hỏi như \textit{số lượng câu}, \textit{độ khó} mong muốn, và \textit{phân bổ độ khó} giữa các câu hỏi. Tương ứng với: \ref{nfr:07}.
		
		\item \textbf{Hỏi gợi ý:} Có thể thiết lập \textit{tần suất} hiển thị gợi ý và \textit{mức độ chi tiết} của gợi ý. Tương ứng với: \ref{nfr:08}.
		
		\item \textbf{Đề xuất chủ đề liên quan:} Cho phép người dùng \textit{thêm} các chủ đề quan tâm hoặc \textit{bỏ} các chủ đề không quan tâm ra khỏi danh sách đề xuất.Tương ứng với: \ref{nfr:09}.
	\end{itemize}
	
	\item \textbf{Availability} \label{ac:02}: Đặc tính này tập trung vào việc đảm bảo hệ thống luôn có thể được truy cập và sử dụng, đặc biệt là trong các tình huống \textit{thời gian sinh viên truy cập không ổn định} hoặc có sự tập trung người dùng lớn. Việc mất khả năng truy cập hệ thống sẽ ảnh hưởng đến chất lượng học tập của sinh viên - lớp người dùng luôn phải cân đối thời gian cho mọi việc, cũng như ảnh hưởng tiến độ xây dựng bài học của các giảng viên, trợ giảng,... Tương ứng với: \ref{nfr:10}, \ref{nfr:11}, \ref{nfr:12}.
	
	\item \textbf{Data consistency + integrity} \label{ac:03}, vì:
	\begin{itemize}
		\item Yêu cầu hệ thống phải \textit{đảm bảo tính đúng đắn} của các tài liệu bài giảng được đăng tải. Tương ứng với: \ref{nfr:13}.
		\item Yêu cầu \textit{dữ liệu đăng tải phải được giữ an toàn} khỏi các truy cập trái phép hoặc mất mát. Tương ứng với: \ref{nfr:14}.
		\item Đảm bảo \textit{mọi dữ liệu hiển thị phải đồng bộ} và nhất quán giữa tất cả các người dùng đang sử dụng hệ thống. Tương ứng với: \ref{nfr:15}.
		\item Các thao tác quan trọng phải đảm bảo tính toàn vẹn giao dịch (transactional integrity) và lịch sử chỉnh sửa nội dung khóa học phải được ghi lại để phục vụ truy vết. Tương ứng với: \ref{nfr:16}, \ref{nfr:17}
	\end{itemize}
\end{enumerate}

\textbf{Các đặc tính phụ liên quan}\\

Các đặc tính sau đây mô tả các yêu cầu hiệu năng và khả năng mở rộng của hệ thống:

\begin{itemize}
	\item \textbf{Performance (Hiệu năng):} Yêu cầu \textit{tối ưu hóa hiệu năng} của các mô hình AI để đảm bảo phản hồi nhanh chóng. Tương ứng với: \ref{nfr:18}, \ref{nfr:19}, \ref{nfr:20}.
	\item \textbf{Concurrency (Đồng thời):} Đảm bảo hệ thống có khả năng xử lý và phục vụ cho \textit{nhiều người dùng cùng lúc} mà không gặp lỗi hoặc giảm chất lượng dịch vụ. Tương ứng với: \ref{nfr:21}, \ref{nfr:22}.
	\item \textbf{Elasticity (Đàn hồi/Co giãn):} Đảm bảo hệ thống có khả năng mở rộng hoặc thu hẹp tài nguyên để đối phó với \textit{thời gian sử dụng không đều}, đặc biệt là khi tải trọng hệ thống \textit{tập trung cao vào mùa thi}. Tương ứng với: \ref{nfr:23}, \ref{nfr:24}, \ref{nfr:25}.
\end{itemize}

\subsubsection{Đánh giá sự đánh đổi}
\textbf{Performance và Security }

Giữa hiệu năng và bảo mật luôn tồn tại sự đánh đổi rõ rệt. Các cơ chế bảo mật như mã hóa dữ liệu, xác thực token, phân quyền theo vai trò hay ghi nhận audit log đều đảm bảo an toàn cho thông tin học viên, nhưng đồng thời tạo thêm chi phí xử lý cho mỗi request. Điều này có thể ảnh hưởng trực tiếp đến yêu cầu phản hồi dưới 300ms theo NFR-01.  

\textbf{Scalability và Consistency }

Khi hệ thống cần phục vụ lượng lớn học viên trong các khung giờ cao điểm, việc mở rộng theo chiều ngang là điều bắt buộc. Tuy nhiên, sự phân tán này khiến dữ liệu khó giữ được tính nhất quán tuyệt đối. Trong môi trường có nhiều instance dịch vụ và nhiều replica cơ sở dữ liệu, các thao tác cập nhật thường dẫn đến eventual consistency. Điều này không gây vấn đề lớn với các tác vụ như truy cập nội dung bài học, nhưng lại nguy hiểm đối với các thao tác quan trọng như nộp bài quiz, chấm điểm hoặc cập nhật tiến độ học tập, nơi yêu cầu strong consistency gần như bắt buộc.  

\textbf{Scalability và Performance }

Khả năng mở rộng cũng tạo ra xung đột trực tiếp với hiệu năng. Khi hệ thống scale-out, mỗi request phải đi qua nhiều tầng hơn như load balancer, service mesh hoặc gateway; đồng thời dữ liệu được phân tán khiến việc truy cập trở nên tốn thời gian hơn. Điều này có thể làm tăng đáng kể độ trễ, đặc biệt với các thao tác được gọi thường xuyên như tải quiz hoặc lấy gợi ý từ AI engine.  

\textbf{Extensibility và Performance }

Cuối cùng, khả năng mở rộng chức năng cũng tạo ra sự đánh đổi với hiệu năng. Khi hệ thống được chia nhỏ thành nhiều module hoặc microservices, các boundary tăng lên, kéo theo chi phí giao tiếp giữa các module — cả về network, serialization và kiểm soát phiên bản. Điều này khiến performance tổng thể có thể giảm so với kiến trúc monolithic.  

\subsubsection{Đề Xuất Các Phong Cách Kiến Trúc}

Dựa trên việc phân tích các đặc tính kiến trúc cốt lõi (\textbf{Configurability}, \textbf{Availability}, \textbf{Data Consistency + Integrity}) và các đặc tính phụ (\textbf{Performance}, \textbf{Concurrency}, \textbf{Elasticity}), có thể đề xuất ba phong cách kiến trúc phù hợp để triển khai hệ thống ITS: \textbf{Modular Monolith}, \textbf{Microservices Architecture} và \textbf{Service-Based Architecture}. Mỗi phong cách đều có thế mạnh riêng trong việc đáp ứng các yêu cầu phi chức năng (NFRs), đồng thời cũng có những đánh đổi cần cân nhắc.

\subsubsubsection{Kiến trúc Modular Monolith}

Kiến trúc Modular Monolith ($Modular Monolith$) phù hợp cho các hệ thống cần \textbf{Performance} cao và độ trễ thấp, vì toàn bộ logic vận hành trong cùng một tiến trình, không phải chịu chi phí truyền thông mạng giữa các module. Điều này đặc biệt hữu ích với các thao tác yêu cầu phản hồi dưới 300ms như tải nội dung bài học, nộp bài hoặc lấy gợi ý từ AI engine.

Kiến trúc này cũng hỗ trợ mức độ \textbf{Configurability} tốt nếu được tổ chức theo các domain rõ ràng (Domain-Driven Design). Mỗi module được cô lập theo chức năng như $Learning Progress$, $Content$, $Quiz$, $Recommendation$, giúp việc mở rộng hoặc cập nhật thuật toán mới trở nên dễ dàng mà không ảnh hưởng đến toàn bộ hệ thống.

Tuy nhiên, Modular Monolith bị hạn chế về \textbf{Elasticity} và \textbf{Concurrency}. Toàn bộ hệ thống chỉ có thể \textit{scale} theo chiều ngang ở mức \textit{deploy instance} toàn bộ ứng dụng, dẫn đến lãng phí tài nguyên khi một số module nóng (\textit{hot modules}) như $Quiz$ hoặc $AI recommendation$ bị quá tải nhưng các module khác vẫn nhàn rỗi. Ngoài ra, lỗi ở một module có thể ảnh hưởng đến toàn bộ ứng dụng, làm giảm mức độ \textbf{Availability} của hệ thống.

\subsubsubsection{Kiến trúc Microservices}

Kiến trúc Microservices ($Microservices Architecture$) giúp giải quyết triệt để các yêu cầu \textbf{Elasticity} và \textbf{Availability}. Mỗi dịch vụ có thể \textit{scale} độc lập theo lượng truy cập thực tế. Trong các khung giờ cao điểm (7–10h tối), chỉ những \textit{service} chịu tải nặng mới cần \textit{scale-out}, tối ưu chi phí vận hành đồng thời đảm bảo hệ thống duy trì \textbf{Performance} ổn định.

Microservices cũng hỗ trợ \textbf{Availability} cao nhờ \textit{isolation}. Khi một \textit{service} gặp sự cố, các \textit{service} khác vẫn có thể hoạt động bình thường, tránh tình trạng “crash toàn hệ thống” thường thấy ở \textit{monolith}. Các cơ chế \textit{retry}, \textit{idempotent API} và \textit{event-driven communication} cũng giúp đảm bảo \textbf{Data Consistency + Integrity} (không mất dữ liệu khi nộp bài hoặc cập nhật tiến độ).

Tuy nhiên, Microservices tạo ra nhiều đánh đổi liên quan đến \textbf{Performance}. Mỗi yêu cầu có thể phải đi qua API Gateway, \textit{service mesh} hoặc nhiều \textit{hop} mạng, làm tăng độ trễ. Đây là rủi ro đối với NFR yêu cầu phản hồi dưới 300ms. Đồng thời, độ phức tạp bảo mật (\textbf{Data Consistency + Integrity}: \textit{zero-trust}, RBAC phân tán, \textit{audit} nhiều \textit{service}) cũng tăng lên đáng kể.

\subsubsubsection{Kiến trúc Service-Based}

Kiến trúc Service-Based ($Service$-$Based$ $Architecture$) là giải pháp trung gian giữa Modular Monolith và Microservices. Trong phong cách này, hệ thống được chia thành một số dịch vụ kích thước vừa (\textit{coarse-grained services}) như $User Service$, $Learning Service$, $Quiz Service$ và $Recommendation Service$. Mỗi \textit{service} có thể triển khai độc lập nhưng kích thước lớn hơn \textit{microservice}, giúp giảm bớt số lượng \textit{service} và độ phức tạp tổng thể.

Phong cách này tạo sự cân bằng tốt giữa các đặc tính kiến trúc:
\begin{itemize}
	\item Cải thiện \textbf{Elasticity} và \textbf{Concurrency} so với Modular Monolith vì có thể \textit{scale} từng \textit{service} độc lập.
	\item Giảm độ trễ (\textbf{Performance}) so với Microservices vì số lượng \textit{hop} mạng ít hơn và hạn chế chồng chéo giao tiếp.
	\item Tăng \textbf{Availability} bằng cách cô lập lỗi ở cấp \textit{service} nhưng không tạo quá nhiều \textit{dependency} phân tán.
	\item Giữ mức \textbf{Configurability} tốt nhờ cấu trúc theo domain rõ ràng.
\end{itemize}
Service-Based Architecture cũng dễ bảo mật hơn (\textbf{Data Consistency + Integrity}) so với Microservices vì số lượng \textit{entry points} và \textit{communication paths} ít hơn, giúp triển khai các yêu cầu \textit{Security} như RBAC, \textit{audit logging} và \textit{encryption} thuận lợi hơn.

Nhược điểm là khả năng \textit{scale} mịn (\textit{fine-grained scalability}) vẫn không bằng Microservices, và các \textit{service} có thể trở nên “quá lớn” theo thời gian nếu không quản lý module hợp lý.

\subsubsection{Lựa Chọn Phong Cách Kiến Trúc}

Dựa trên việc phân tích các đặc tính kiến trúc cốt lõi (\textbf{Performance}, \textbf{Elasticity}, \textbf{Availability}) và các đặc tính quan trọng khác như \textbf{Data Consistency + Integrity} và \textbf{Configurability}, nhóm quyết định lựa chọn \textbf{Service-Based Architecture} làm phong cách kiến trúc chính cho hệ thống ITS.

Kiến trúc Service-Based được xem là lựa chọn phù hợp nhất vì nó mang lại sự cân bằng hợp lý giữa hiệu năng, khả năng mở rộng và độ phức tạp hệ thống. Với kiến trúc này, hệ thống được chia thành một số dịch vụ kích thước vừa, mỗi dịch vụ đại diện cho một domain quan trọng như $User Service$, $Learning Service$, $Quiz Service$, $Course Service$ và $AI Service$. Các dịch vụ này chạy độc lập nhưng không bị chia nhỏ quá mức như \textit{microservices}, giảm đáng kể chi phí giao tiếp mạng và phức tạp vận hành.

Trước yêu cầu \textbf{Performance} (phản hồi dưới 300ms), kiến trúc Service-Based có khả năng đảm bảo độ trễ thấp nhờ số lượng \textit{service hop} hạn chế. Điều này giúp hệ thống dễ đạt được mục tiêu phản hồi dưới 300ms, đồng thời vẫn duy trì logic module hoá theo domain như ở Modular Monolith.

Về \textbf{Elasticity} và \textbf{Concurrency}, Service-Based đáp ứng tốt khi cho phép \textit{scale-out} độc lập từng \textit{service} theo nhu cầu thực tế. Các dịch vụ có lưu lượng cao trong giờ cao điểm — đặc biệt là $Quiz Service$ và $Recommendation Service$ — có thể mở rộng theo chiều ngang mà không ảnh hưởng những phần ít sử dụng hơn. Kiến trúc này không tạo ra hàng chục dịch vụ nhỏ như \textit{microservices}, giúp chi phí \textit{scaling} hợp lý và dễ kiểm soát hơn.

Đối với \textbf{Availability}, Service-Based cung cấp mức độ cô lập lỗi tốt hơn \textit{monolith}. Một lỗi xảy ra trong $Quiz Service$ không làm toàn bộ hệ thống ngừng hoạt động, từ đó hỗ trợ mục tiêu SLA 99.9\%. Kiến trúc cũng hỗ trợ các kỹ thuật như \textit{retry}, \textit{idempotent update} và \textit{event-driven synchronization} để đảm bảo \textbf{Data Consistency + Integrity} (không mất dữ liệu khi nộp bài hoặc cập nhật tiến độ học tập).

Tuy \textbf{Data Consistency + Integrity} (Bảo mật) không phải đặc tính cốt lõi quyết định cấu trúc, nhưng Service-Based Architecture giúp triển khai các yêu cầu bảo mật dễ dàng hơn so với \textit{microservices} nhờ số lượng điểm giao tiếp và đường truyền ít hơn.

Cuối cùng, Service-Based cũng đáp ứng tốt yêu cầu \textbf{Configurability}. Khi cần bổ sung module nội dung, thêm thuật toán gợi ý mới hoặc tích hợp với hệ thống LMS/Payment Gateway bên ngoài, đội ngũ chỉ cần mở rộng hoặc thêm mới các \textit{service} mà không ảnh hưởng đến cấu trúc tổng thể.

\textbf{Tóm lại}, Service-Based Architecture cung cấp sự cân bằng tối ưu giữa hiệu năng, khả năng mở rộng, độ sẵn sàng và khả năng tiến hóa hệ thống, đồng thời có độ phức tạp phù hợp với năng lực triển khai. Vì vậy, đây là phong cách kiến trúc phù hợp nhất với các NFR và đặc tính đã phân tích, và được nhóm lựa chọn làm nền tảng cho thiết kế kiến trúc của hệ thống ITS.

Chi tiết xem mục \ref{adr:01}.

\subsection{Thiết kế kiến trúc}
\subsubsection{Module view}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\linewidth]{"Images/5. PhanTichThietKeHeThong/KTPM-Module View.drawio.png"}
	\caption{Module view - Nguyên tắc tổ chức}
	\label{fig:module-view-Overview}
\end{figure}

\begin{enumerate}
	\item \textbf{Nguyên tắc Tổ chức Module}
	\begin{enumerate}
		\item Hệ thống được thiết kế dựa trên \textbf{Service-Based Architecture (SBA)} nhằm tối ưu hóa tính module hóa và đảm bảo \textbf{phân tách mối quan tâm (separation of concerns)}.
		\item Cấu trúc Module View chi tiết hóa cách thức mã nguồn hệ thống được tổ chức thành 9 module, tuân thủ \textbf{Nguyên tắc Trách nhiệm Đơn nhất (Single Responsibility Principle)}.
	\end{enumerate}
	
	\item \textbf{Mô tả Tổng quát các Module}
	
	Các module được phân loại thành hai nhóm chính: Dịch vụ Nghiệp vụ Miền (Domain Services) và Dịch vụ Hỗ trợ Hạ tầng và Truy cập (Infrastructure \& Access Services).
	
	\begin{enumerate}
		\item \textbf{Dịch vụ Nghiệp vụ Miền (Domain Services)}
		
		Gồm 6 module cốt lõi, mỗi module tập trung quản lý một miền nghiệp vụ chuyên biệt:
		
		\begin{longtable}{|p{3cm}|p{3.5cm}|p{8cm}|}
			\hline
			\textbf{Module} & \textbf{Mục đích} & \textbf{Trách nhiệm chính} \\
			\hline
			\endfirsthead
			\multicolumn{3}{c}%
			{{\bfseries Bảng Domain Services tiếp theo}} \\
			\hline
			\textbf{Module} & \textbf{Mục đích} & \textbf{Trách nhiệm chính} \\
			\hline
			\endhead
			\hline
			\multicolumn{3}{|r|}{{Tiếp theo trên trang sau}} \\
			\hline
			\endfoot
			\hline
			\endlastfoot
			IAM Service & Quản lý Danh tính, Truy cập và Thông tin người dùng. & Thực hiện xác thực và phân quyền; quản lý hồ sơ, quyền hạn, vai trò và vòng đời người dùng. \\ \hline
			Quiz Service & Quản lý mọi hoạt động liên quan tới bài kiểm tra. & Tạo, chỉnh sửa, lưu trữ cấu trúc câu hỏi và bài quiz; chấm điểm và lưu trữ phiên làm bài. \\ \hline
			System Service & Cung cấp các chức năng hỗ trợ chung mang tính nền tảng. & Cung cấp cơ chế logging cho các thao tác bảo mật; quản lý các tài nguyên media (video, document, ảnh). \\ \hline
			Learning Service & Quản lý hành trình học tập và tiến trình của người dùng. & Theo dõi tiến trình học (completion, progress); quản lý các forum/thảo luận của mỗi khóa học. \\ \hline
			Course Service & Quản lý vòng đời của khóa học. & Quản lý metadata, trạng thái khóa học; xử lý quy trình đăng ký học viên và các quy tắc truy cập. \\ \hline
			AI Service & Hỗ trợ học viên thông qua việc áp dụng Trí tuệ Nhân tạo. & Phân tích hành vi và tiến trình học; đề xuất nội dung, tài liệu, hoặc lộ trình học tập phù hợp. \\ \hline
		\end{longtable}
		
		\item \textbf{Dịch vụ Hỗ trợ Hạ tầng và Truy cập (Infrastructure \& Access Services)}
		
		Các module thiết yếu trong việc quản lý kết nối, giao tiếp và cấu hình:
		
		\begin{itemize}
			\item \textbf{API Gateway:} Đóng vai trò là Điểm truy cập duy nhất (Single Entry Point) cho client. Trách nhiệm chính là Định tuyến yêu cầu tới dịch vụ tương ứng.
			\item \textbf{Service Registry:} Cung cấp cơ chế Tìm kiếm Dịch vụ (Service Discovery). Trách nhiệm chính là Lưu trữ metadata và danh sách các instance đang chạy của các dịch vụ.
			\item \textbf{User Interface (UI):} Là điểm tương tác cuối cùng với người dùng. Trách nhiệm chính là Hiển thị nội dung, thu thập input, gọi các API qua API Gateway và xử lý kết quả.
		\end{itemize}
	\end{enumerate}
	
	\item \textbf{Tổ chức, phân lớp, phụ thuộc giữa các Module}
	
	\begin{figure}[H]
		\centering
		\includegraphics[width=0.8\linewidth]{"Images/5. PhanTichThietKeHeThong/KTPM-Module View.drawio (1).png"}
		\caption{Module view - Package diagram}
		\label{fig:module-view-pkg}
	\end{figure}
	
	\begin{enumerate}
		\item \textbf{Nguyên tắc Phân lớp Nội bộ:} Mỗi module dịch vụ đều tuân theo \textbf{Layered Architecture} nội bộ thống nhất (Controller $\to$ Service $\to$ Repository $\to$ Entity) để phân tách rõ ràng trách nhiệm.
		\item \textbf{Luồng Truy cập:} UI $\to$ API Gateway $\to$ Domain Services. Gateway đóng vai trò là \textbf{Facade}, bảo vệ các dịch vụ nghiệp vụ.
		\item \textbf{Phụ Thuộc giữa các Module (Inter-Module Dependencies):} Các module giao tiếp qua REST API theo hai kiểu:
		\begin{itemize}
			\item \textbf{Phụ thuộc qua API Gateway (<<use>>):} Tất cả Domain Services đều có mối quan hệ <<use>> với API Gateway (Gateway là thành phần duy nhất được phép gọi các dịch vụ này).
			\item \textbf{Phụ thuộc giữa các Domain Services (S2S):}
			\begin{itemize}
				\item IAM Service và Course Service đều <<use>> \textbf{Media Service} và \textbf{Logging Service} (trong System Service).
				\item AI Service <<use>> \textbf{Learning Service, Course Service, Quiz Service} để lấy dữ liệu tiến trình học và điểm số.
			\end{itemize}
		\end{itemize}
		\item \textbf{Phụ thuộc vào Service Registry:} Tất cả Domain Service và API Gateway phụ thuộc vào Service Registry theo hai chiều:
		\begin{itemize}
			\item \textbf{Đăng ký (Registration):}
			\begin{itemize}
				\item Mỗi Domain Service (IAM, Learning, Quiz, Course, System, AI) khi khởi động sẽ tự động đăng ký các instance của mình bao gồm địa chỉ IP, cổng và các metadata cần thiết. 
				\item Service Registry duy trì danh sách các instance hợp lệ dựa trên cơ chế Heartbeat/Healthcheck, TTL (Time-To-Live), và thực hiện deregister khi một service không còn hoạt động. Việc đăng ký là bắt buộc, vì nếu một service không được đăng ký, các service khác sẽ không thể phát hiện và gọi đến nó. 
			\end{itemize}
			\item \textbf{Tra cứu (Discovery):}
			\begin{itemize}
				\item Các thành phần cần gọi tới dịch vụ khác sẽ thực hiện tra cứu thông qua Service Registry để lấy thông tin địa chỉ runtime của các service. Ví dụ, API Gateway khi nhận request từ client sẽ query Service Registry để xác định instance phù hợp của service tương ứng dựa trên tên logic.  
				\item Tương tự, trong các kịch bản service-to-service, một service khi muốn gọi service khác (ví dụ AI tới Learning) cũng phải tham khảo Registry để lấy endpoint mới nhất. 
			\end{itemize}
		\end{itemize}
		Cơ chế này cho phép giao tiếp giữa các service dựa trên tên service thay vì địa chỉ IP hoặc cổng cứng, từ đó đảm bảo loose coupling giữa các thành phần trong hệ thống. 
	\end{enumerate}
\end{enumerate}
\subsubsection{Component \& Connector View }
\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\linewidth]{"Images/5. PhanTichThietKeHeThong/KTPM-Component & Connector View.drawio.png"}
	\caption{Component \& Connector view}
	\label{fig:cnc-view}
\end{figure}
\begin{enumerate}
	\item \textbf{Identity \& Access Management (IAM) Service}
	\begin{itemize}
		\item \textbf{User Component:} Xử lý toàn bộ tác vụ liên quan đến danh tính và truy cập người dùng: đăng ký, đăng nhập, xác thực (authentication), quản lý phiên, cấp token và quản lý hồ sơ người dùng.
		\item \textbf{Interface:} \texttt{User Service} --- cung cấp cho \texttt{API Gateway} để thực hiện xác thực và truy vấn thông tin người dùng.
	\end{itemize}
	
	\item \textbf{Quiz Service}
	\begin{itemize}
		\item \textbf{Quiz Component:} Quản lý toàn bộ nghiệp vụ về bài kiểm tra: tạo quiz, quản lý câu hỏi, thực hiện quiz, chấm điểm tự động và lưu kết quả. Tích hợp với Learning Service để cung cấp dữ liệu đánh giá.
		\item \textbf{Manage Quiz Attempt (Interface):} Cung cấp cho \texttt{AI Service} để lấy thông tin về kết quả các lần làm quiz của học viên trong khóa học, từ đó đưa ra gợi ý lộ trình học.
		\item \textbf{Interface:} \texttt{Quiz Service} --- cho phép \texttt{API Gateway} gửi request về quiz và kết quả đánh giá.
	\end{itemize}
	
	\item \textbf{Course Service}
	\begin{itemize}
		\item \textbf{Course Component:} Quản lý nội dung khóa học: tạo khóa học, chương, bài học; quản lý nội dung đa phương tiện; thiết lập điều kiện tiên quyết và quyền truy cập. Tương tác với Media Component để lưu trữ tài nguyên.
		\item \textbf{Manage Course Info (Interface):} Cung cấp cho \texttt{AI Service} để lấy thông tin về khóa học của học viên.
		\item \textbf{Interface:} \texttt{Course Service} --- dùng bởi \texttt{API Gateway} để thao tác dữ liệu khóa học.
	\end{itemize}
	
	\item \textbf{Learning Service}
	\begin{itemize}
		\item \textbf{Learning Component:} Theo dõi tiến độ học tập: ghi nhận trạng thái hoàn thành, thời gian học, điểm số, tính phần trăm tiến độ và lưu lịch sử học. Cung cấp dữ liệu cho AI Service để phân tích và gợi ý.
		\item \textbf{Manage Learning Progress (Interface):} Cung cấp cho \texttt{AI Service} để lấy thông tin về quá trình học của học viên.
		\item \textbf{Interface:} \texttt{Learning Service} --- cho \texttt{API Gateway} truy vấn tiến độ và lịch sử học tập.
	\end{itemize}
	
	\item \textbf{AI Service}
	\begin{itemize}
		\item \textbf{AI Component:} Phân tích dữ liệu từ Learning, Course và Quiz để xây dựng mô hình học tập cá nhân hóa; đề xuất lộ trình học, khóa học phù hợp và gợi ý nội dung thông minh.
		\item \textbf{Interface:} \texttt{AI Service} --- cung cấp cho \texttt{API Gateway} để lấy đề xuất cá nhân hóa.
	\end{itemize}
	
	\item \textbf{System Service}
	\begin{itemize}
		\item \textbf{Logging Component:} Thu thập và lưu trữ log từ mọi service; phân loại log; hỗ trợ phân tích và giám sát hệ thống.
		\begin{itemize}
			\item \textbf{Write Log (Interface):} Cung cấp cho \texttt{IAM Service} và \texttt{Course Service} để ghi log lại các thao tác về xác thực, đăng ký người dùng và tạo, chỉnh sửa khóa học.
			\item \textbf{Interface:} \texttt{Logging Service} --- cung cấp cho \texttt{API Gateway} để xem log.
		\end{itemize}
		\item \textbf{Media Component:} Xử lý tài nguyên đa phương tiện: upload, lưu trữ, tối ưu hóa và phân phối nội dung media. Hỗ trợ Course và IAM (ảnh đại diện).
		\begin{itemize}
			\item \textbf{Manage media file, Manage image file (Interfaces):} Cung cấp cho \texttt{IAM Service} và \texttt{Course Service} để thao tác với các file media như ảnh đại diện, video bài giảng.
			\item \textbf{Interface:} \texttt{File Service} --- cho \texttt{API Gateway} thao tác với file media.
		\end{itemize}
	\end{itemize}
	
	\item \textbf{API Gateway Component}
	\begin{itemize}
		\item \textbf{Chức năng:} Thực hiện định tuyến request tới đúng service, xác thực/ủy quyền dựa trên IAM, cân bằng tải và áp dụng chính sách bảo mật tập trung.
	\end{itemize}
	
	\item \textbf{User Interface Component}
	\begin{itemize}
		\item \textbf{Chức năng:} Tầng giao diện người dùng: hiển thị nội dung khóa học, làm quiz, xem tiến độ, nhận gợi ý từ AI và quản lý hồ sơ cá nhân.
		\item \textbf{Giao tiếp:} Giao tiếp với backend thông qua \texttt{API Gateway}.
	\end{itemize}
\end{enumerate}
\subsubsection{Allocation view}
\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\linewidth]{"Images/5. PhanTichThietKeHeThong/KTPM-Allocation View.drawio.png"}
	\caption{Component \& Connector view}
	\label{fig:alloc-view}
\end{figure}

\begin{enumerate}

	\item Tổng quan mô hình triển khai hệ thống
	
\indent Hệ thống được triển khai theo mô hình service-based architecture trên nền tảng container hóa, trong đó toàn bộ các service backend được triển khai tập trung trong một ECS Cluster thuộc Amazon Web Services. Người dùng truy cập hệ thống từ máy cá nhân thông qua Internet, giao diện người dùng được host độc lập trên AWS Amplify. Tất cả các yêu cầu từ phía frontend đều được chuyển tiếp về backend thông qua API Gateway, đóng vai trò là điểm vào duy nhất của hệ thống. Mô hình này giúp tách biệt rõ ràng giữa tầng giao diện và tầng xử lý nghiệp vụ, đồng thời tăng cường tính bảo mật và khả năng kiểm soát truy cập. 
	
	\item Kiến trúc service-based trong ECS Cluster 
	
\indent Trong ECS Cluster, mỗi service được triển khai dưới dạng một container độc lập, tương ứng với một Docker image (artifact). Hệ thống không sử dụng kiến trúc microservices mà áp dụng mô hình service-based, trong đó các service vẫn tách biệt về mặt triển khai, chức năng và vòng đời, nhưng chia sẻ cùng một cơ sở dữ liệu trung tâm. Các service chính bao gồm: API Gateway, Service Registry, IAM Service, AI Service, Course Service, Learning Service, Quiz Service, Media Service và Logging Service. Mỗi service tồn tại như một môi trường thực thi riêng biệt (execution environment) và giao tiếp với các service khác thông qua REST API trên mạng nội bộ của ECS. 
	
	\item Cơ chế định tuyến và cân bằng tải với Spring Cloud Gateway và Eureka 
	
\indent API Gateway trong mô hình này được hiện thực bằng Spring Cloud Gateway và tích hợp với Eureka từ Service Registry. Thông qua cơ chế service discovery, API Gateway có khả năng tự động phát hiện các instance của service, thực hiện cân bằng tải (load balancing), kiểm tra trạng thái (health check) và định tuyến request đến đúng service còn hoạt động. Điều này giúp hệ thống đạt được tính chịu lỗi cao (fault tolerance) và khả năng mở rộng động (dynamic scalability) khi số lượng instance của từng service thay đổi. 
	
	\item Service Registry và cơ chế phát hiện dịch vụ 
		
\indent Service Registry được triển khai như một container riêng trong ECS Cluster và đóng vai trò trung tâm trong việc đăng ký và tra cứu service. Khi mỗi service khởi động, nó sẽ tự động đăng ký thông tin (tên service, địa chỉ, cổng, trạng thái) với Registry. API Gateway dựa trên thông tin này để định tuyến request một cách linh hoạt mà không cần cấu hình cứng địa chỉ từng service. Kiến trúc này giúp hệ thống tránh phụ thuộc tĩnh, đồng thời đặc biệt phù hợp với môi trường container có khả năng scale linh động theo tải. 
	
	\item Kiến trúc tầng dữ liệu và lưu trữ 
		
\indent Về tầng dữ liệu, hệ thống sử dụng một PostgreSQL Database dùng chung được triển khai dưới dạng dịch vụ managed của Amazon RDS for PostgreSQL. Tất cả các service nghiệp vụ, bao gồm IAM Service, AI Service, Course Service, Learning Service, Quiz Service và Logging Service, đều kết nối trực tiếp tới cơ sở dữ liệu này để đọc và ghi dữ liệu. Riêng Media Service không lưu trữ dữ liệu file trong database mà chỉ sử dụng database để quản lý metadata, còn toàn bộ dữ liệu media vật lý được lưu trữ trên Amazon S3. Việc tách riêng dữ liệu quan hệ và dữ liệu file giúp tối ưu hiệu năng truy xuất, chi phí lưu trữ và khả năng mở rộng hệ thống. 
	
	\item Quy trình triển khai hệ thống và CI/CD với GitHub Actions và CloudFormation 
	
\indent Quy trình triển khai của hệ thống được tự động hóa theo mô hình CI/CD. Mỗi service được build từ mã nguồn và đóng gói thành một Docker image với phiên bản tương ứng, chẳng hạn như api-gateway:v1.0, course-service:v1.0, media-service:v1.0. Khi push source code lên repository trên GitHub, GitHub Actions sẽ tự động kích hoạt pipeline CI để thực hiện các bước: kiểm tra mã nguồn, build Docker image và đẩy image lên Amazon Elastic Container Registry (ECR). 
		
Sau khi image được lưu trữ trên ECR, quá trình triển khai hạ tầng và cập nhật service được thực hiện thông qua AWS CloudFormation. CloudFormation chịu trách nhiệm khởi tạo và cập nhật các tài nguyên như ECS Cluster, Task Definition, Service, Load Balancer và các cấu hình mạng liên quan. ECS sẽ tự động pull các image mới nhất từ ECR để khởi tạo hoặc cập nhật container. Khi container khởi động, các service sẽ kết nối tới Service Registry để đăng ký, đồng thời thiết lập kết nối tới PostgreSQL Database, riêng Media Service thiết lập thêm kết nối tới S3. Sau khi toàn bộ service sẵn sàng, API Gateway bắt đầu tiếp nhận request từ frontend và điều phối xử lý trong nội bộ hệ thống. Quy trình này cho phép triển khai tự động, lặp lại, giảm sai sót thủ công và rút ngắn thời gian release. 
		
	\item Luồng xử lý tổng thể trong môi trường triển khai 
	
\indent Luồng xử lý tổng thể của hệ thống diễn ra theo trình tự: người dùng thao tác trên giao diện web được host trên AWS Amplify, request được gửi qua Internet tới API Gateway trong ECS Cluster. API Gateway tiến hành xác thực thông qua IAM Service, sau đó dựa trên Service Registry để định tuyến request tới Course Service, Learning Service, Quiz Service, AI Service hoặc Media Service tùy theo nghiệp vụ. Các service này xử lý logic chuyên biệt và truy cập trực tiếp vào PostgreSQL Database để lấy hoặc cập nhật dữ liệu. Trong trường hợp xử lý file, Media Service sẽ thực hiện lưu trữ và truy xuất nội dung từ S3. Toàn bộ hoạt động của hệ thống được Logging Service ghi nhận và lưu trữ phục vụ công tác giám sát, theo dõi và phân tích hệ thống. 

\end{enumerate}

